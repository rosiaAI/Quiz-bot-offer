## План рефакторинга бэкенда проекта Quiz-bot

**Мотивация для рефакторинга:**

Текущее состояние кодовой базы Quiz-bot характеризуется значительным техническим долгом, накопленным в процессе эволюции проекта и смены разработчиков.  **Дальнейшее развитие и поддержка проекта в текущем виде становятся крайне затруднительными и рискованными.**

**Проблемы, которые необходимо решить рефакторингом:**

*   **Высокая сложность и монолитность кода:**  Кодовая база избыточно сложна, запутана и трудна для понимания. Отсутствие модульности и четкой архитектуры затрудняет навигацию, отладку, и внесение изменений.
*   **Низкое качество кода:**  Наличие legacy-кода, дублирования, "поглощения" ошибок, и непоследовательный нейминг  ведут к нестабильности, ошибкам, и увеличению времени на разработку новых функций.
*   **Уязвимость и неэффективность ядра системы:**  Модуль `db_commands.py`, отвечающий за ключевые операции с базой данных, является "узким местом" и содержит рискованные практики, потенциально снижающие безопасность и производительность.
*   **Проблемы масштабируемости и поддержки:** Текущая архитектура и качество кода препятствуют масштабированию проекта и эффективной поддержке в долгосрочной перспективе.
*   **Риски безопасности:** Использование "сырых" SQL-запросов и недостаточная валидация данных создают потенциальные уязвимости.

**Перспективы после рефакторинга:**

*   **Упрощение и повышение понятности кодовой базы:**  Рефакторинг сделает код более чистым, модульным и легким для понимания, что существенно снизит порог вхождения для новых разработчиков и облегчит поддержку.
*   **Улучшение надежности и стабильности:** Устранение ошибок, улучшенная обработка исключений, и переход к более надежным практикам программирования повысят стабильность работы бота и снизят вероятность сбоев.
*   **Повышение производительности и масштабируемости:** Оптимизация работы с базой данных, а также рассмотрение перехода на более подходящий фреймворк, обеспечат лучшую производительность и возможность масштабирования проекта при росте нагрузки.
*   **Улучшение безопасности:** Уход от "сырых" SQL-запросов и усиление валидации данных повысят безопасность системы и снизят риски уязвимостей.
*   **Ускорение разработки и внедрения новых функций:**  Модульная и понятная кодовая база позволит быстрее разрабатывать и внедрять новые функции, а также оперативнее реагировать на изменения требований рынка.
*   **Создание основы для долгосрочного развития и поддержки:**  Рефакторинг заложит прочный фундамент для дальнейшего развития и поддержки проекта, делая его более гибким и расширяемым.

**Примерный план рефакторинга:**

1.  **Рефакторинг ядра системы (приоритет №1):**
    *   **`tgbot/models/db_commands.py`**:
        *   Декомпозиция файла на модули/классы.
        *   Переход от "сырых" SQL-запросов к Django ORM.
        *   Реализация надежной обработки ошибок.
        *   Разделение синхронного и асинхронного кода.
        *   Удаление legacy-кода и неиспользуемых функций.
    *   **`admin_panel/telebot/models.py`**:
        *   Разделение моделей по файлам.
        *   Вынос бизнес-логики из моделей в сервисы.
        *   Рефакторинг связей между моделями.
        *   Устранение прямых запросов к БД из админки.

2.  **Рефакторинг логики рассылок:**
    *   **`tgbot/misc/mailing.py` и `group_bot/misc/mailing.py`**:
        *   Упрощение многопоточности.
        *   Улучшение обработки ошибок рассылок.
        *   Устранение дублирования кода.

3.  **Рефакторинг UI-логики и хендлеров:**
    *   **`tgbot/handlers/user.py` и `group_bot/handlers/group.py`**:
        *   Декомпозиция длинных хендлеров.
        *   Устранение дублирования кода.
        *   Разделение UI и бизнес-логики.
        *   Валидация callback-data.
        *   Переработка обработки ошибок.
    *   **`tgbot/keyboards/inline.py`**:
        *   Унификация и упрощение inline-клавиатур.
        *   Устранение дублирования и legacy-кода.

4.  **Улучшение качества кода и нейминга:**
    *   **`tgbot/misc/tools.py` и `backend/tgbot/misc/schedule.py`**:
        *   Устранение "поглощения" исключений.
        *   Рефакторинг перегруженных функций.
        *   Удаление отладочного кода.
    *   **`tgbot/misc/texts.py`**:
        *   Оптимизация хранения и доступа к текстам (кэширование, Redis, статические файлы).
    *   **Нейминг**:  Тотальный ренейминг проекта для улучшения читаемости и соответствия конвенциям.

5.  **Оценка перехода на современный фреймворк (стратегическая задача):**
    *   Провести анализ и оценку целесообразности миграции на FastAPI или aiohttp для улучшения асинхронности и производительности.

6.  **Документирование кода:**
    *   Сопровождать каждый этап рефакторинга подробным документированием кода.

## Предложение по рефакторингу бэкенда Quiz-bot

Для более гибкого подхода к рефакторингу, предлагается разбить работы на несколько вариантов рефакторинга, каждый из которых фокусируется на определенном наборе проблем и имеет свою стоимость и сроки.

**Варианты рефакторинга:**

**Базовый (Быстрые исправления и улучшение качества кода)**

*   **Цель:** Устранение наиболее критичных проблем качества кода и повышение стабильности работы бота без глубокой архитектурной переработки.
*   **Включает:**
    *   Устранение legacy-кода (закомментированный код, неиспользуемые функции) во всем проекте.
    *   Рефакторинг нейминга переменных, функций и классов во всем проекте для улучшения читаемости и соответствия конвенциям.
    *   Отключение DEBUG режима в production (`admin_panel/admin_panel/settings.py`).
    *   Удаление пустого файла `reply.py`.
    *   Устранение дублирования кода.
    *   Исправление ряда багов и предположительных проблем на фронтенде.
    *   Удаление отладочного кода из `group_bot/handlers/group.py` и `backend/tgbot/misc/schedule.py`.
    *   Аудит всех сырых SQL-запросов в проекте в `db_commands.py`.
    *   Разделение методов на синхронные (_sync) и асинхронные (основные), внедрение sync_to_async для обертки критичных синхронных вызовов в `db_commands.py`.
    *   Улучшение обработки ошибок: замена широких исключений на точные, добавление логирования, устранение "поглощения" ошибок в `tools.py` и `schedule.py`, добавление проверок на блокировку бота пользователями в рассылках.
    *   Валидация callback-данных в `group_bot/handlers/group.py`.
    *   Замена рекурсии в `broadcaster.py/send_message` на итеративный подход с ограничением попыток (например, цикл + счетчик)
    *   Добавление обработки asyncio.CancelledError для корректного завершения задач.
    *   Документация по запуску
    *   Документация по описанию архитектуры (технологии, функционал и реализованные фичи, документация по назначению файлов и папок)
    *   Документация к API (API endpoints)
    *   Документация к методам в коде

*   **Оценка времени:** 40 рабочих дней.
*   **Оценка стоимости:** 330 500 руб рублей.

**Стандартный (Рефакторинг ядра и архитектуры)**

*   **Цель:** Рефакторинг ядра системы, повышение модульности, улучшение архитектуры, устранение критических уязвимостей и повышение производительности в дополнение к Базовому варианту.
*   **Включает:**  Базовый вариант рефакторинга **плюс**
    *   Полный рефакторинг, включая декомпозицию, переход на Django ORM, улучшение обработки ошибок и разделение синхронного/асинхронного кода.
    *   Декомпозиция db_commands.py на репозитории (UserRepository, AdminRepository)
    *   Разделение моделей на файлы, вынос бизнес-логики, рефакторинг связей, устранение прямых запросов из админки.
    *   Оптимизация реализации рассылок, устранение дублирования и проблем асинхронности.
    *   Декомпозиция хендлеров, разделение UI и бизнес-логики, рефакторинг обработки ошибок.
    *   Рефакторинг inline-клавиатур, устранение дублирования и legacy-кода.
    *   Кэширование текстов (texts.py) через Redis.
    *   Покрытие критичных модулей юнит-тестами.
    *   Документация к бд (ER-диаграмма БД)
    *   Более подробная документация архитектуры и API

*   **Оценка времени:** 90 рабочих дней.
*   **Оценка стоимости:** 780 000 рублей.


На основе анализа, выделены следующие **критические уязвимости и проблемы, требующие немедленного исправления**:

1.  **Риски в `db_commands.py`**:  "Сырые" SQL-запросы, отсутствие валидации, неадекватная обработка ошибок в критически важном файле. **Потенциальные уязвимости безопасности (SQL-инъекции), риски целостности данных, сбои.**
2.  **Риск переполнения стека в `send_message`**: Рекурсивный вызов `send_message` в `broadcaster.py`. **Риск падения бота при массовых рассылках.**
3.  **Ошибки расчета даты в `_is_last_day_of_month()`**: Функция в `group_bot/misc/mailing.py`. **Риск некорректной работы рассылок рейтингов, критично для функциональности платных квизов.**
4.  **Путаница типов и потенциальная избыточность экспорта в Excel**: Ошибки в `admin_panel/resources.py`. **Менее критично, но указывает на общие проблемы архитектуры и качества кода.**
5.  **DEBUG=True на production**:  Включенный DEBUG в production (`admin_panel/admin_panel/settings.py`).  **Критическая уязвимость безопасности, немедленно отключить.**
